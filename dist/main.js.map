{"version":3,"sources":["../src/main.ts"],"sourcesContent":["import * as core from '@actions/core'\nimport * as fs from 'fs'\nimport path from 'path'\nimport { BundleIdsResponse, Profile } from './@types'\nimport * as io from '@actions/io'\nimport appStoreConnect from './client'\n\nmodule ProvisioningProfileDownloader {\n  export const run = async (): Promise<void> => {\n    try {\n      const bundleId: string = core.getInput('bundle-id', {\n        required: true,\n        trimWhitespace: true\n      })\n      const apiKeyId = core.getInput('api-key-id', {\n        required: true,\n        trimWhitespace: true\n      })\n      const issuerId = core.getInput('issuer-id', {\n        required: true,\n        trimWhitespace: true\n      })\n      const profileType = core.getInput('profile-type', {\n        required: false,\n        trimWhitespace: true\n      })\n      const apiPrivateKey = core.getInput('api-private-key', {\n        required: false,\n        trimWhitespace: true\n      })\n      const apiPrivateKeyFile = core.getInput('api-private-key-file', {\n        required: false,\n        trimWhitespace: true\n      })\n      const tokenDuration = core.getInput('token-duration', {\n        required: false,\n        trimWhitespace: true\n      })\n\n      if (apiPrivateKey.length === 0) {\n        const keyPath = path.resolve(__dirname, apiPrivateKeyFile)\n        const apiPrivateKeyFileCheck = fs.statSync(keyPath).isFile() || false\n        if (!apiPrivateKeyFileCheck) {\n          throw new Error(\n            \"Specify either 'api-private-key' or 'api-private-key-file'.\"\n          )\n        }\n      }\n\n      if (tokenDuration !== '' && Number.isNaN(tokenDuration)) {\n        throw new Error(\"The 'token-duration' must be an integer value.\")\n      }\n\n      const duration = tokenDuration !== '' ? Number(tokenDuration) : undefined\n      if (duration !== undefined && (duration < 1 || duration > 1200)) {\n        throw new Error(\"The 'token-duration' must be in the range of 1 to 1200.\")\n      }\n\n      if (!process.env.HOME) {\n        throw new Error('Environment variable `HOME` is not defined!')\n      }\n\n      core.info(`bundle-id: ${bundleId}`)\n      core.info(`api-key-id: ${apiKeyId}`)\n      core.info(`issuer-id: ${issuerId}`)\n      core.info(`profile-type: ${profileType}`)\n      core.info(`api-private-key: ${apiPrivateKey ? 'specified' : undefined}`)\n      core.info(`api-private-key-file: ${apiPrivateKeyFile}`)\n      core.info(`token-duration: ${tokenDuration}`)\n\n      const privateKey =\n        apiPrivateKey || fs.readFileSync(path.resolve(apiPrivateKeyFile))\n\n      const client = appStoreConnect.Client({\n        privateKey,\n        issuerId,\n        apiKeyId,\n        duration\n      })\n\n      const response = await client.listBundleIds({\n        'filter[identifier]': bundleId,\n        include: 'profiles',\n        'fields[profiles]':\n          'bundleId,certificates,createdDate,devices,expirationDate,name,platform,profileContent,profileState,profileType,uuid'\n      })\n\n      const bundleIds = response as BundleIdsResponse\n\n      const profileIds = bundleIds.data\n        .filter(\n          value =>\n            value.attributes.identifier === bundleId &&\n            value.relationships.profiles !== undefined\n        )\n        .flatMap(bundle => bundle.relationships.profiles!.data)\n        .map(data => data.id)\n\n      const profiles = bundleIds.included\n        .filter(\n          include =>\n            include.type === 'profiles' &&\n            profileIds.includes(include.id) &&\n            include.attributes.profileState === 'ACTIVE' &&\n            include.attributes.profileType === profileType\n        )\n        .map(include => include as Profile)\n\n      if (\n        profiles.findIndex(\n          profile =>\n            profile.attributes.uuid !== undefined &&\n            profile.attributes.profileContent\n        )\n      ) {\n        throw new Error(\n          'Profile attributes `uuid` and `profileContent` must be defined!'\n        )\n      }\n      const basePath = path.join(\n        process.env.HOME!,\n        '/Library/MobileDevice/Provisioning Profiles'\n      )\n      await io.mkdirP(basePath)\n\n      profiles\n        .map(async profile => {\n          const profileFilename = `${profile.attributes.uuid}.mobileprovision`\n          return {\n            fullPath: path.join(basePath, profileFilename),\n            profileType: profile.attributes.profileType,\n            name: profile.attributes.name,\n            content: profile.attributes.profileContent!\n          }\n        })\n        .forEach(async output => {\n          const buffer = Buffer.from((await output).content, 'base64')\n          fs.writeFileSync((await output).fullPath, buffer)\n          core.info(\n            `Wrote ${(await output).profileType} profile '${(await output).name\n            }' to '${(await output).fullPath}'.`\n          )\n        })\n      core.setOutput(\n        'profiles',\n        JSON.stringify(\n          profiles.map(value => {\n            return {\n              name: value.attributes.name,\n              udid: value.attributes.uuid,\n              type: value.attributes.profileType!.toString()\n            }\n          })\n        )\n      )\n    } catch (error: unknown) {\n      if (error instanceof Error) {\n        core.error(error)\n        core.setFailed(error.message)\n      } else {\n        core.error(JSON.stringify(error))\n        core.setFailed(JSON.stringify(error))\n      }\n    }\n  }\n}\n\nProvisioningProfileDownloader.run()\n"],"names":["core","fs","path","io","appStoreConnect","ProvisioningProfileDownloader","run"],"mappings":"AAAA,MAAM,MAAMA,IAAI,MAAM,CAAe;AACrC,MAAM,MAAMC,EAAE,MAAM,CAAI;AACxB,MAAM,CAACC,IAAI,MAAM,CAAM;AAEvB,MAAM,MAAMC,EAAE,MAAM,CAAa;AACjC,MAAM,CAACC,eAAe,MAAM,CAAU;AAEtC,GAAM;;mCACS,GAAG,aAA8B,CAAC;QAC7C,GAAG,CAAC,CAAC;YACH,KAAK,CAAC,QAAQ,GAAW,IAAI,CAAC,QAAQ,CAAC,CAAW,YAAE,CAAC;gBACnD,QAAQ,EAAE,IAAI;gBACd,cAAc,EAAE,IAAI;YACtB,CAAC;YACD,KAAK,CAAC,QAAQ,GAAG,IAAI,CAAC,QAAQ,CAAC,CAAY,aAAE,CAAC;gBAC5C,QAAQ,EAAE,IAAI;gBACd,cAAc,EAAE,IAAI;YACtB,CAAC;YACD,KAAK,CAAC,QAAQ,GAAG,IAAI,CAAC,QAAQ,CAAC,CAAW,YAAE,CAAC;gBAC3C,QAAQ,EAAE,IAAI;gBACd,cAAc,EAAE,IAAI;YACtB,CAAC;YACD,KAAK,CAAC,WAAW,GAAG,IAAI,CAAC,QAAQ,CAAC,CAAc,eAAE,CAAC;gBACjD,QAAQ,EAAE,KAAK;gBACf,cAAc,EAAE,IAAI;YACtB,CAAC;YACD,KAAK,CAAC,aAAa,GAAG,IAAI,CAAC,QAAQ,CAAC,CAAiB,kBAAE,CAAC;gBACtD,QAAQ,EAAE,KAAK;gBACf,cAAc,EAAE,IAAI;YACtB,CAAC;YACD,KAAK,CAAC,iBAAiB,GAAG,IAAI,CAAC,QAAQ,CAAC,CAAsB,uBAAE,CAAC;gBAC/D,QAAQ,EAAE,KAAK;gBACf,cAAc,EAAE,IAAI;YACtB,CAAC;YACD,KAAK,CAAC,aAAa,GAAG,IAAI,CAAC,QAAQ,CAAC,CAAgB,iBAAE,CAAC;gBACrD,QAAQ,EAAE,KAAK;gBACf,cAAc,EAAE,IAAI;YACtB,CAAC;YAED,EAAE,EAAE,aAAa,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;gBAC/B,KAAK,CAAC,OAAO,GAAG,IAAI,CAAC,OAAO,CAAC,SAAS,EAAE,iBAAiB;gBACzD,KAAK,CAAC,sBAAsB,GAAG,EAAE,CAAC,QAAQ,CAAC,OAAO,EAAE,MAAM,MAAM,KAAK;gBACrE,EAAE,GAAG,sBAAsB,EAAE,CAAC;oBAC5B,KAAK,CAAC,GAAG,CAAC,KAAK,CACb,CAA6D;gBAEjE,CAAC;YACH,CAAC;YAED,EAAE,EAAE,aAAa,KAAK,CAAE,KAAI,MAAM,CAAC,KAAK,CAAC,aAAa,GAAG,CAAC;gBACxD,KAAK,CAAC,GAAG,CAAC,KAAK,CAAC,CAAgD;YAClE,CAAC;YAED,KAAK,CAAC,QAAQ,GAAG,aAAa,KAAK,CAAE,IAAG,MAAM,CAAC,aAAa,IAAI,SAAS;YACzE,EAAE,EAAE,QAAQ,KAAK,SAAS,KAAK,QAAQ,GAAG,CAAC,IAAI,QAAQ,GAAG,IAAI,GAAG,CAAC;gBAChE,KAAK,CAAC,GAAG,CAAC,KAAK,CAAC,CAAyD;YAC3E,CAAC;YAED,EAAE,GAAG,OAAO,CAAC,GAAG,CAAC,IAAI,EAAE,CAAC;gBACtB,KAAK,CAAC,GAAG,CAAC,KAAK,CAAC,CAA6C;YAC/D,CAAC;YAED,IAAI,CAAC,IAAI,EAAE,WAAW,EAAE,QAAQ;YAChC,IAAI,CAAC,IAAI,EAAE,YAAY,EAAE,QAAQ;YACjC,IAAI,CAAC,IAAI,EAAE,WAAW,EAAE,QAAQ;YAChC,IAAI,CAAC,IAAI,EAAE,cAAc,EAAE,WAAW;YACtC,IAAI,CAAC,IAAI,EAAE,iBAAiB,EAAE,aAAa,GAAG,CAAW,aAAG,SAAS;YACrE,IAAI,CAAC,IAAI,EAAE,sBAAsB,EAAE,iBAAiB;YACpD,IAAI,CAAC,IAAI,EAAE,gBAAgB,EAAE,aAAa;YAE1C,KAAK,CAAC,UAAU,GACd,aAAa,IAAI,EAAE,CAAC,YAAY,CAAC,IAAI,CAAC,OAAO,CAAC,iBAAiB;YAEjE,KAAK,CAAC,MAAM,GAAG,eAAe,CAAC,MAAM,CAAC,CAAC;gBACrC,UAAU;gBACV,QAAQ;gBACR,QAAQ;gBACR,QAAQ;YACV,CAAC;YAED,KAAK,CAAC,QAAQ,GAAG,KAAK,CAAC,MAAM,CAAC,aAAa,CAAC,CAAC;gBAC3C,CAAoB,qBAAE,QAAQ;gBAC9B,OAAO,EAAE,CAAU;gBACnB,CAAkB,mBAChB,CAAqH;YACzH,CAAC;YAED,KAAK,CAAC,SAAS,GAAG,QAAQ;YAE1B,KAAK,CAAC,UAAU,GAAG,SAAS,CAAC,IAAI,CAC9B,MAAM,EACL,KAAK,GACH,KAAK,CAAC,UAAU,CAAC,UAAU,KAAK,QAAQ,IACxC,KAAK,CAAC,aAAa,CAAC,QAAQ,KAAK,SAAS;cAE7C,OAAO,EAAC,MAAM,GAAI,MAAM,CAAC,aAAa,CAAC,QAAQ,CAAE,IAAI;cACrD,GAAG,EAAC,IAAI,GAAI,IAAI,CAAC,EAAE;;YAEtB,KAAK,CAAC,QAAQ,GAAG,SAAS,CAAC,QAAQ,CAChC,MAAM,EACL,OAAO,GACL,OAAO,CAAC,IAAI,KAAK,CAAU,aAC3B,UAAU,CAAC,QAAQ,CAAC,OAAO,CAAC,EAAE,KAC9B,OAAO,CAAC,UAAU,CAAC,YAAY,KAAK,CAAQ,WAC5C,OAAO,CAAC,UAAU,CAAC,WAAW,KAAK,WAAW;cAEjD,GAAG,EAAC,OAAO,GAAI,OAAO;;YAEzB,EAAE,EACA,QAAQ,CAAC,SAAS,EAChB,OAAO,GACL,OAAO,CAAC,UAAU,CAAC,IAAI,KAAK,SAAS,IACrC,OAAO,CAAC,UAAU,CAAC,cAAc;eAErC,CAAC;gBACD,KAAK,CAAC,GAAG,CAAC,KAAK,CACb,CAAiE;YAErE,CAAC;YACD,KAAK,CAAC,QAAQ,GAAG,IAAI,CAAC,IAAI,CACxB,OAAO,CAAC,GAAG,CAAC,IAAI,EAChB,CAA6C;YAE/C,KAAK,CAAC,EAAE,CAAC,MAAM,CAAC,QAAQ;YAExB,QAAQ,CACL,GAAG,QAAO,OAAO,GAAI,CAAC;gBACrB,KAAK,CAAC,eAAe,MAAM,OAAO,CAAC,UAAU,CAAC,IAAI,CAAC,gBAAgB;gBACnE,MAAM,CAAC,CAAC;oBACN,QAAQ,EAAE,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE,eAAe;oBAC7C,WAAW,EAAE,OAAO,CAAC,UAAU,CAAC,WAAW;oBAC3C,IAAI,EAAE,OAAO,CAAC,UAAU,CAAC,IAAI;oBAC7B,OAAO,EAAE,OAAO,CAAC,UAAU,CAAC,cAAc;gBAC5C,CAAC;YACH,CAAC,EACA,OAAO,QAAO,MAAM,GAAI,CAAC;gBACxB,KAAK,CAAC,MAAM,GAAG,MAAM,CAAC,IAAI,EAAE,KAAK,CAAC,MAAM,EAAE,OAAO,EAAE,CAAQ;gBAC3D,EAAE,CAAC,aAAa,EAAE,KAAK,CAAC,MAAM,EAAE,QAAQ,EAAE,MAAM;gBAChD,IAAI,CAAC,IAAI,EACN,MAAM,GAAG,KAAK,CAAC,MAAM,EAAE,WAAW,CAAC,UAAU,GAAG,KAAK,CAAC,MAAM,EAAE,IAAI,CAClE,MAAM,GAAG,KAAK,CAAC,MAAM,EAAE,QAAQ,CAAC,EAAE;YAEvC,CAAC;YACH,IAAI,CAAC,SAAS,CACZ,CAAU,WACV,IAAI,CAAC,SAAS,CACZ,QAAQ,CAAC,GAAG,EAAC,KAAK,GAAI,CAAC;gBACrB,MAAM,CAAC,CAAC;oBACN,IAAI,EAAE,KAAK,CAAC,UAAU,CAAC,IAAI;oBAC3B,IAAI,EAAE,KAAK,CAAC,UAAU,CAAC,IAAI;oBAC3B,IAAI,EAAE,KAAK,CAAC,UAAU,CAAC,WAAW,CAAE,QAAQ;gBAC9C,CAAC;YACH,CAAC;QAGP,CAAC,CAAC,KAAK,EAAE,KAAK,EAAW,CAAC;YACxB,EAAE,EAAE,KAAK,YAAY,KAAK,EAAE,CAAC;gBAC3B,IAAI,CAAC,KAAK,CAAC,KAAK;gBAChB,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,OAAO;YAC9B,CAAC,MAAM,CAAC;gBACN,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,SAAS,CAAC,KAAK;gBAC/B,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,SAAS,CAAC,KAAK;YACrC,CAAC;QACH,CAAC;IACH,CAAC;GA7JI,6BAA6B,KAA7B,6BAA6B;;AAgKpCC,6BAA6B,CAACC,GAAG"}