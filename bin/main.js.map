{"version":3,"sources":["../src/main.ts"],"sourcesContent":["import * as core from '@actions/core'\nimport * as fs from 'fs'\nimport path from 'path'\nimport {fileURLToPath} from 'url'\nimport {BundleIdsResponse, Profile} from './@types'\nimport * as io from '@actions/io'\nimport Client from './client.js'\n\nconst __filename = fileURLToPath(import.meta.url)\nconst __dirname = path.dirname(__filename)\n\nexport class ProvisioningProfileDownloader {\n  run = async (): Promise<void> => {\n    try {\n      const bundleId: string = core.getInput('bundle-id', {\n        required: true,\n        trimWhitespace: true\n      })\n      const apiKeyId = core.getInput('api-key-id', {\n        required: true,\n        trimWhitespace: true\n      })\n      const issuerId = core.getInput('issuer-id', {\n        required: true,\n        trimWhitespace: true\n      })\n      const profileType = core.getInput('profile-type', {\n        required: false,\n        trimWhitespace: true\n      })\n      const apiPrivateKey = core.getInput('api-private-key', {\n        required: false,\n        trimWhitespace: true\n      })\n      const apiPrivateKeyFile = core.getInput('api-private-key-file', {\n        required: false,\n        trimWhitespace: true\n      })\n      const tokenDuration = core.getInput('token-duration', {\n        required: false,\n        trimWhitespace: true\n      })\n\n      if (apiPrivateKey.length === 0) {\n        const keyPath = path.resolve(__dirname, apiPrivateKeyFile)\n        const apiPrivateKeyFileCheck = fs.statSync(keyPath).isFile() || false\n        if (!apiPrivateKeyFileCheck) {\n          throw new Error(\n            \"Specify either 'api-private-key' or 'api-private-key-file'.\"\n          )\n        }\n      }\n\n      if (tokenDuration !== '' && Number.isNaN(tokenDuration)) {\n        throw new Error(\"The 'token-duration' must be an integer value.\")\n      }\n\n      const duration = tokenDuration !== '' ? Number(tokenDuration) : undefined\n      if (duration !== undefined && (duration < 1 || duration > 1200)) {\n        throw new Error(\n          \"The 'token-duration' must be in the range of 1 to 1200.\"\n        )\n      }\n\n      if (!process.env.HOME) {\n        throw new Error('Environment variable `HOME` is not defined!')\n      }\n\n      core.info(`bundle-id: ${bundleId}`)\n      core.info(`api-key-id: ${apiKeyId}`)\n      core.info(`issuer-id: ${issuerId}`)\n      core.info(`profile-type: ${profileType}`)\n      core.info(`api-private-key: ${apiPrivateKey ? 'specified' : undefined}`)\n      core.info(`api-private-key-file: ${apiPrivateKeyFile}`)\n      core.info(`token-duration: ${tokenDuration}`)\n\n      const privateKey =\n        apiPrivateKey || fs.readFileSync(path.resolve(apiPrivateKeyFile))\n\n      const client = new Client({\n        privateKey,\n        issuerId,\n        apiKeyId,\n        duration\n      })\n\n      const response = await client.listBundleIds({\n        'filter[identifier]': bundleId,\n        include: 'profiles',\n        'fields[profiles]':\n          'bundleId,certificates,createdDate,devices,expirationDate,name,platform,profileContent,profileState,profileType,uuid'\n      })\n\n      const bundleIds = response as BundleIdsResponse\n\n      const profileIds = bundleIds.data\n        .filter(\n          value =>\n            value.attributes.identifier === bundleId &&\n            value.relationships.profiles !== undefined\n        )\n        .flatMap(bundle => bundle.relationships.profiles!.data)\n        .map(data => data.id)\n\n      const profiles = bundleIds.included\n        .filter(\n          include =>\n            include.type === 'profiles' &&\n            profileIds.includes(include.id) &&\n            include.attributes.profileState === 'ACTIVE' &&\n            include.attributes.profileType === profileType\n        )\n        .map(include => include as Profile)\n\n      if (\n        profiles.findIndex(\n          profile =>\n            profile.attributes.uuid !== undefined &&\n            profile.attributes.profileContent\n        )\n      ) {\n        throw new Error(\n          'Profile attributes `uuid` and `profileContent` must be defined!'\n        )\n      }\n      const basePath = path.join(\n        process.env.HOME!,\n        '/Library/MobileDevice/Provisioning Profiles'\n      )\n      await io.mkdirP(basePath)\n\n      profiles\n        .map(async profile => {\n          const profileFilename = `${profile.attributes.uuid}.mobileprovision`\n          return {\n            fullPath: path.join(basePath, profileFilename),\n            profileType: profile.attributes.profileType,\n            name: profile.attributes.name,\n            content: profile.attributes.profileContent!\n          }\n        })\n        .forEach(async output => {\n          const buffer = Buffer.from((await output).content, 'base64')\n          fs.writeFileSync((await output).fullPath, buffer)\n          core.info(\n            `Wrote ${(await output).profileType} profile '${\n              (await output).name\n            }' to '${(await output).fullPath}'.`\n          )\n        })\n      core.setOutput(\n        'profiles',\n        JSON.stringify(\n          profiles.map(value => {\n            return {\n              name: value.attributes.name,\n              udid: value.attributes.uuid,\n              type: value.attributes.profileType!.toString()\n            }\n          })\n        )\n      )\n    } catch (error: unknown) {\n      if (error instanceof Error) {\n        core.error(error)\n        core.setFailed(error.message)\n      } else {\n        core.error(JSON.stringify(error))\n        core.setFailed(JSON.stringify(error))\n      }\n    }\n  }\n}\n\nnew ProvisioningProfileDownloader().run()\n"],"names":["core","fs","path","fileURLToPath","io","Client","__filename","import","meta","url","__dirname","dirname","ProvisioningProfileDownloader","run","bundleId","getInput","apiKeyId","issuerId","profileType","apiPrivateKey","apiPrivateKeyFile","tokenDuration","length","keyPath","resolve","apiPrivateKeyFileCheck","statSync","isFile","Error","Number","isNaN","duration","undefined","process","env","HOME","info","privateKey","readFileSync","client","response","listBundleIds","include","bundleIds","profileIds","data","filter","value","attributes","identifier","relationships","profiles","flatMap","bundle","map","id","included","type","includes","profileState","findIndex","profile","uuid","profileContent","basePath","join","mkdirP","profileFilename","fullPath","name","content","forEach","output","buffer","Buffer","from","writeFileSync","setOutput","JSON","stringify","udid","toString","error","setFailed","message"],"mappings":"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"}