"use strict";var _regeneratorRuntime=_interopRequireDefault(require("regenerator-runtime")),core=_interopRequireWildcard(require("@actions/core")),fs=_interopRequireWildcard(require("fs")),_path=_interopRequireDefault(require("path")),io=_interopRequireWildcard(require("@actions/io")),_client=_interopRequireDefault(require("./client"));function asyncGeneratorStep(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(j){c(j);return}h.done?b(i):Promise.resolve(i).then(d,e)}function _asyncToGenerator(k){return function(){var l=this,m=arguments;return new Promise(function(b,c){var a=k.apply(l,m);function d(i){asyncGeneratorStep(a,b,c,d,e,"next",i)}function e(n){asyncGeneratorStep(a,b,c,d,e,"throw",n)}d(void 0)})}}function _instanceof(o,p){return null!=p&&"undefined"!=typeof Symbol&&p[Symbol.hasInstance]?p[Symbol.hasInstance](o):o instanceof p}function _interopRequireDefault(q){return q&&q.__esModule?q:{default:q}}function _interopRequireWildcard(q){if(q&&q.__esModule)return q;var r={};if(null!=q){for(var f in q)if(Object.prototype.hasOwnProperty.call(q,f)){var s=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(q,f):{};s.get||s.set?Object.defineProperty(r,f,s):r[f]=q[f]}}return r.default=q,r}var run=_asyncToGenerator(_regeneratorRuntime.default.mark(function _callee(){var t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J;return _regeneratorRuntime.default.wrap(function(K){for(;;)switch(K.prev=K.next){case 0:if(K.prev=0,t=core.getInput("bundle-id",{required:!0,trimWhitespace:!0}),u=core.getInput("api-key-id",{required:!0,trimWhitespace:!0}),v=core.getInput("issuer-id",{required:!0,trimWhitespace:!0}),w=core.getInput("profile-type",{required:!1,trimWhitespace:!0}),x=core.getInput("api-private-key",{required:!1,trimWhitespace:!0}),y=core.getInput("api-private-key-file",{required:!1,trimWhitespace:!0}),z=core.getInput("token-duration",{required:!1,trimWhitespace:!0}),0!==x.length){K.next=13;break}if(A=_path.default.resolve(__dirname,y),B=fs.statSync(A).isFile()||!1){K.next=13;break}throw new Error("Specify either 'api-private-key' or 'api-private-key-file'.");case 13:if(!(""!==z&&Number.isNaN(z))){K.next=15;break}throw new Error("The 'token-duration' must be an integer value.");case 15:if(!(void 0!==(C=""!==z?Number(z):void 0)&&(C<1||C>1200))){K.next=18;break}throw new Error("The 'token-duration' must be in the range of 1 to 1200.");case 18:if(process.env.HOME){K.next=20;break}throw new Error("Environment variable `HOME` is not defined!");case 20:return core.info("bundle-id: ".concat(t)),core.info("api-key-id: ".concat(u)),core.info("issuer-id: ".concat(v)),core.info("profile-type: ".concat(w)),core.info("api-private-key: ".concat(x?"specified":void 0)),core.info("api-private-key-file: ".concat(y)),core.info("token-duration: ".concat(z)),D=x||fs.readFileSync(_path.default.resolve(y)),E=_client.default.Client({privateKey:D,issuerId:v,apiKeyId:u,duration:C}),K.next=31,E.listBundleIds({"filter[identifier]":t,include:"profiles","fields[profiles]":"bundleId,certificates,createdDate,devices,expirationDate,name,platform,profileContent,profileState,profileType,uuid"});case 31:if(H=(G=F=K.sent).data.filter(function(L){return L.attributes.identifier===t&& void 0!==L.relationships.profiles}).flatMap(function(M){return M.relationships.profiles.data}).map(function(N){return N.id}),!(I=G.included.filter(function(O){return"profiles"===O.type&&H.includes(O.id)&&"ACTIVE"===O.attributes.profileState&&O.attributes.profileType===w}).map(function(P){return P})).findIndex(function(Q){return void 0!==Q.attributes.uuid&&Q.attributes.profileContent})){K.next=37;break}throw new Error("Profile attributes `uuid` and `profileContent` must be defined!");case 37:return J=_path.default.join(process.env.HOME,"/Library/MobileDevice/Provisioning Profiles"),K.next=40,io.mkdirP(J);case 40:I.map(_asyncToGenerator(_regeneratorRuntime.default.mark(function _callee(R){var S;return _regeneratorRuntime.default.wrap(function(T){for(;;)switch(T.prev=T.next){case 0:return S="".concat(R.attributes.uuid,".mobileprovision"),T.abrupt("return",{fullPath:_path.default.join(J,S),profileType:R.attributes.profileType,name:R.attributes.name,content:R.attributes.profileContent});case 2:case"end":return T.stop()}},_callee)}))).forEach(_asyncToGenerator(_regeneratorRuntime.default.mark(function _callee(U){var V;return _regeneratorRuntime.default.wrap(function(W){for(;;)switch(W.prev=W.next){case 0:return W.next=2,U;case 2:return V=Buffer.from.call(Buffer,W.sent.content,"base64"),W.next=5,U;case 5:return fs.writeFileSync.call(fs,W.sent.fullPath,V),W.next=8,U;case 8:return W.next=10,U;case 10:return W.next=12,U;case 12:core.info.call(core,"Wrote ".concat.call("Wrote ",W.sent.profileType," profile '").concat.call("Wrote ".concat.call("Wrote ",W.sent.profileType," profile '"),W.sent.name,"' to '").concat.call("Wrote ".concat.call("Wrote ",W.sent.profileType," profile '").concat.call("Wrote ".concat.call("Wrote ",W.sent.profileType," profile '"),W.sent.name,"' to '"),W.sent.fullPath,"'."));case 13:case"end":return W.stop()}},_callee)}))),core.setOutput("profiles",JSON.stringify(I.map(function(X){return{name:X.attributes.name,udid:X.attributes.uuid,type:X.attributes.profileType.toString()}}))),K.next=47;break;case 44:K.prev=44,K.t0=K.catch(0),_instanceof(K.t0,Error)?(core.error(K.t0),core.setFailed(K.t0.message)):(core.error(JSON.stringify(K.t0)),core.setFailed(JSON.stringify(K.t0)));case 47:case"end":return K.stop()}},_callee,null,[[0,44]])}));run()